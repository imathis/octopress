
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Avi Tzurel</title>
  <meta name="author" content="Avi Tzurel">

  
  <meta name="description" content="I work a lot with MongoDB, and this is not the &#8220;Why not MongoDB&#8221; or &#8220;Why MongoDB&#8221; type of post, I know it&#8217;s popular to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://avi.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Avi Tzurel" type="application/atom+xml">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-33891290-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Avi Tzurel</a></h1>
  
    <h2>Blogging about Ruby/Rails and related web stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:avi.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/22/export-mongo-collection-to-json-with-query/">Real Life Usage for Mongoexport (and a Bonus)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-22T16:39:00+02:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2013</time>
        
         | <a href="/blog/2013/11/22/export-mongo-collection-to-json-with-query/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I work a lot with MongoDB, and this is not the &#8220;Why not MongoDB&#8221; or &#8220;Why MongoDB&#8221; type of post, I know it&#8217;s popular to trash Mongo lately.</p>

<p>Anyway, while working with Mongo, from time to time I need to export a collection, or a subset of the collection based on a query.</p>

<p>I love using <code>mongoexport</code> because you basically get JSON file out of it (or CSV) and from there on you can pretty much do anything you want with it.</p>

<p>You can use Amazon&#8217;s MapReduce or any other solution you may want.</p>

<p>For example, when I do usually is export a list I need, load it into Rails console and work with the output, queue it up to the worker list etc&#8230;</p>

<p>Let&#8217;s cover some scenarios I use the most</p>

<h2>Export Collection To JSON</h2>

<p>Actually, I never use it, since the collections are too big for the disk to handle at once, we have a sharded collection, so no one-disk solution can hold the data.</p>

<p>That been said, I think for most people this can be very useful.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mongoexport --host HOST --port PORT --db DB_NAME -u USERNAME -p PASSWORD --collection COLLECTION_NANE -q '{}' --out YOUR_FILENAME.json</span></code></pre></td></tr></table></div></figure>


<h2>Export part of the collection to JSON (using a query)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mongoexport --host HOST --port PORT --db DB_NAME -u USERNAME -p PASSWORD --collection COLLECTION_NANE -q '{ "some_numeric_field": { "$gte": 100 } }' --out YOUR_FILENAME.json</span></code></pre></td></tr></table></div></figure>


<p>The most important part here is that the -q options needs to be a valid JSON format query that Mongo knows how to handle <code>{ "some_numeric_field": { "$gte": 100 } }</code>. You can of course use far more complicated queries, but for most cases I don&#8217;t need to.</p>

<h2>Bonus</h2>

<p>I use <a href="http://kapeli.com/dash">Dash</a> every day, multiple times a day, so it was only natural to have a dash snippet that I can use</p>

<p>Dash snippets are basically a way to paste some code using a shortcode, so typing <code>mongoexport</code> in the console pops up a window where I can complete the rest of the command easily without remembering the options.</p>

<p>Here&#8217;s the Dash snippets</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mongoexport --host __host__ --port __port__ --db __db-name__ -u __username__ -p __pass__ --collection __collection__ -q '__query__' --out __filename__.json</span></code></pre></td></tr></table></div></figure>


<p>And this is what the window looks like when I type the shortcode, I tab through the place holders and there&#8217;s a no-brainer way to remember the command and the options.</p>

<p><img src="http://f.cl.ly/items/2x3G2t3N2o2I0817220t/Screenshot_11_22_13__4_56_PM.png" alt="dash snippet window" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/06/how-to-easily-generate-beautiful-api-documentation/">How to Easily Generate Beautiful Api Documentation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-06T15:48:00+03:00" pubdate data-updated="true">Oct 6<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/10/06/how-to-easily-generate-beautiful-api-documentation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We recently opened a couple of API endpoints at <a href="http://gogobot.com">Gogobot</a> to the public.</p>

<p>I was looking for a way to generate API documentation in a good looking way, one that will appeal to my fellow developers.</p>

<p>After a little while search with Google, I thought I had it nailed with a Twitter Bootstrap theme, but the way I had to generate the documentation was too manual, I had to edit lots of files and I really didn&#8217;t find it &#8220;easy&#8221;.</p>

<p>So, I was looking around some more, and I finally found a really easy way to generate API documentation here: <a href="http://apidocjs.com/">apidocjs.com</a></p>

<p>It really nailed everything I was looking for:</p>

<ol>
<li>Super easy customizable template.</li>
<li>Intuitive documentation</li>
<li>Document versioning</li>
<li>Version compare</li>
</ol>


<p>Everything is super easy and at your fingertips.</p>

<p>One thing that I have to say badly about it, is that it&#8217;s using an old deprecated Markdown parser, but I am already working to fix it and post a Pull Request for it (Gotta love open source)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/14/move-jobs-from-one-queue-to-another-sidekiq/">Move Jobs From One Queue to Another - Sidekiq</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-14T17:36:00+03:00" pubdate data-updated="true">Aug 14<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/08/14/move-jobs-from-one-queue-to-another-sidekiq/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have been working with Sidekiq for quite a while now, having many jobs per day working (multiple millions of jobs.)</p>

<p>Sometimes, I queue up tasks to a queue called <code>#{queue_name}_pending</code>, I do this so I can manage the load on the servers. (For example: Stop writing to Mongo, Stop importing contact etc&#8230;)</p>

<p>This way, I can queue up many jobs, and I can move it to the real queue whenever I feel like it or whenever the problem is solved.</p>

<p>I was looking for a way to move tasks from one queue to another.</p>

<p>There&#8217;s nothing built into Sidekiq for this, but obviously, you can just use redis built in commands to do it.</p>

<p>Here&#8217;s the code to do it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">count_block</span> <span class="o">=</span> <span class="nb">proc</span><span class="p">{</span> <span class="no">Sidekiq</span><span class="o">.</span><span class="n">redis</span> <span class="k">do</span> <span class="o">|</span><span class="n">conn</span><span class="o">|</span>
</span><span class='line'>  <span class="n">conn</span><span class="o">.</span><span class="n">llen</span><span class="p">(</span><span class="s2">&quot;queue:</span><span class="si">#{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="n">count_block</span><span class="o">.</span><span class="n">call</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="no">Sidekiq</span><span class="o">.</span><span class="n">redis</span> <span class="k">do</span> <span class="o">|</span><span class="n">conn</span><span class="o">|</span>
</span><span class='line'>    <span class="n">conn</span><span class="o">.</span><span class="n">rpoplpush</span> <span class="s2">&quot;queue:</span><span class="si">#{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">_pending&quot;</span><span class="p">,</span> <span class="s2">&quot;queue:</span><span class="si">#{</span><span class="n">queue_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will move all the items from one queue to another until there are no more jobs.</p>

<p>b.t.w
Obviously, the <code>_pending</code> queues don&#8217;t have any workers assigned to them, the purpose of it is a place holder so the jobs won&#8217;t go to waste and we can resume work when we can.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/26/a-better-todo-comment-for-your-code/">Better TODO Comment for Your Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-26T14:38:00+03:00" pubdate data-updated="true">Jul 26<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/26/a-better-todo-comment-for-your-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Usually, when I have to do something in my code, I add a TODO comment (and forget about it).</p>

<p>For example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserThank</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Scores</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_score</span>
</span><span class='line'>      <span class="k">return</span> <span class="no">Scoring</span><span class="o">::</span><span class="no">UserLeaderboard</span><span class="o">::</span><span class="no">WEIGHTS</span><span class="o">[</span><span class="ss">:thanks</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1"># TODO: Should this be the user attached to the activity or should this be the thanked user?</span>
</span><span class='line'>   <span class="c1"># Ask product and change the code</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_receiver</span>
</span><span class='line'>      <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">user</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I have the shortcuts to show all TODO in vim, but it&#8217;s clearly not in my muscle memory and not in any kind of memory, natural or computerized, I just don&#8217;t do it enough, so it adds up and I feel bad about it.</p>

<p>Today, while coding I encountered this case, where clearly it&#8217;s not just a simple thing, it&#8217;s not just something I as an engineer care about, it&#8217;s a product related thing and affects core user experience.</p>

<p>So, I think I found a better way to actually make sure I DO my TODO.</p>

<p>I thought to myself, what do I notice every single time, I never overlook…</p>

<p>The answer was clear, tests, if a test fails I will never overlook it, will never deploy if a single test fails, same goes for the rest of the team.</p>

<p>so here&#8217;s the solution</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s2">&quot;User Thank&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;should score the user&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">pending</span> <span class="s2">&quot;This is pending some investigation on the product side, right now I will fail it&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="kp">true</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I make use of a super useful Rspec feature, where you pass false or an exception into a pending block, it fails the spec.</p>

<p>I just describe the problem in detail, and that&#8217;s it, this is a piece of code that will be dealt with, before deploy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/19/do-not-use-the-callbacks-that-require-persistence-in-mongoid/">DO NOT Use the Callbacks That Require Persistence in Mongoid</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-19T22:10:00+02:00" pubdate data-updated="true">Feb 19<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/19/do-not-use-the-callbacks-that-require-persistence-in-mongoid/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I started using MongoDB at <a href="http://www.gogobot.com">Gogobot</a> a little while ago.
While using it, I encountered some <a href="http://avi.io/blog/2013/01/30/problems-with-mongoid-and-sidekiq-brainstorming/">problems</a>, but for the most part, things went pretty smooth.</p>

<p>Today, I encountered a bug that surprised me.</p>

<p>While it certainly should not have, I think it can surprise you as well, so I am writing it up here as a fair warning.</p>

<p>For Gogobot, the entire graph is built on top of MongoDB, all the things social are driven by it and for the most parts like I mentioned, we are pretty happy with it.</p>

<h2>SO, What was the problem?</h2>

<p>The entire graph is a mountable engine, we can decide to turn it on or to turn it off at will.
It acts as a data warehouse and the workflows are being managed by the app.</p>

<p>For example:</p>

<p>When model X is created, app is notified and decides what to do with this notification, and so on and so forth.</p>

<p>Everything peachy so far, nothing we haven&#8217;t used hundreds of times in the past.</p>

<p>Here&#8217;s how it works.</p>

<p>We have a model called <code>VisitedPlace</code>, it&#8217;s a representation of a user that visited a certain place</p>

<p>Here&#8217;s the code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">GraphEngine</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">FbPlace</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Timestamps</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">GraphEngine</span><span class="o">::</span><span class="no">Notifications</span><span class="o">::</span><span class="no">NotifiableModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#… rest of code here</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this model includes a module called <code>NotifiableModel</code>, here&#8217;s the important part from it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">GraphEngine</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Notifications</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">NotifiableModel</span>
</span><span class='line'>      <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">after_create</span> <span class="k">do</span>
</span><span class='line'>          <span class="n">send_notification</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">send_notification</span><span class="p">(</span><span class="n">verb</span><span class="p">)</span>
</span><span class='line'>          <span class="c1"># Notify the app here...</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like I said, pretty standard stuff, nothing too fancy, but here&#8217;s where it&#8217;s getting tricky.</p>

<p>This model has a unique index on <code>user_id</code> and <code>place_id</code>. It&#8217;s a unique index and no two documents can exist in the same collection.</p>

<p>BUT… check this out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">GraphEngine</span><span class="o">::</span><span class="no">VisitedPlace</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">GraphEngine</span><span class="o">::</span><span class="no">VisitedPlace</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">place_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>The second query actually failed in the DB level, but the application still returned true.</p>

<p>Meaning, that <code>after_create</code> is actually being called even if the record is <strong>not really persisted</strong>.</p>

<h2>How you can fix? / should you fix?</h2>

<p>For Gogobot, I fixed it using safe mode on those models, I don&#8217;t mind the performance penalty, since I don&#8217;t want to trigger Sidekiq workers that will do all sorts of things twice or three times.</p>

<p>Should you do the same? I am not sure, you need to benchmark your app and see if you can fix it in another way.</p>

<p>Would love to hear back from you in comments/discussion</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/04/building-the-gogobot-social-graph/">Building the Gogobot Social Graph</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T22:11:00+02:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/04/building-the-gogobot-social-graph/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For the past few months I have been super busy building the social graph behind Gogobot.</p>

<p>In this presentation I gave in Israel I go through a fraction of the Gogobot platform and how I implemented a social feature</p>

<script async class="speakerdeck-embed" data-id="5c18bff0512b0130cb6b12313b10154e" src="//speakerdeck.com/assets/embed.js"></script>


<p>Feel free to comment &amp; discuss.</p>

<p>Enjoy!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/30/problems-with-mongoid-and-sidekiq-brainstorming/">Problems With Mongoid and Sidekiq- Brainstorming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T20:13:00+02:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/30/problems-with-mongoid-and-sidekiq-brainstorming/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few weeks back, we started slowly upgrading all of our queues at <a href="http://www.gogobot.com">Gogobot</a> to work with <a href="https://github.com/mperham/sidekiq">Sidekiq</a>.</p>

<p>Posts on how awesome the experience was and how much better Sidekiq is from <a href="http://github.com/defunkt/sidekiq">Resque</a> coming soon, though with all the good came some bad.</p>

<h2>Summary of the solution</h2>

<p>With Sidekiq, we are processing around <strong>25X more</strong> jobs than what we were doing with Resque, processing around 15,000,000 jobs per day, at paces of over 1K per second at times (at peak we go up well past that)</p>

<p>This is how many jobs we processed today…</p>

<p><img src="http://d.pr/i/O9aU+" alt="Sidekiq history graph for today" /></p>

<p>And this is a snapshot of our realtime graph</p>

<p><img src="http://d.pr/i/7Fkr+" alt="Realtime graph snapshot" /></p>

<p>On the MongoDB side we are working with Mongoid and we have a shared environment, 9 shards with 3 replicas in each shard, all running through 2 routers.</p>

<p>Our production mongoid config looks like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">op_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sessions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">HOST_NAME:27017</span> <span class="c1">#Single router R0</span>
</span><span class='line'>      <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">USER_NAME</span>
</span><span class='line'>      <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">PASSWORD</span>
</span><span class='line'>      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DATABASE_NAME</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">consistency</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">:eventual</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are using latest versions of all relevant gems (Sidekiq, Mongoid, Moped, Redis)</p>

<h2>All seems fine right? What&#8217;s the problem?</h2>

<p>The problem is that we have too many connections opening and closing to our mongo instances. (~25-40 new connections per second).</p>

<p>Each time a job is picked up, a connection to Mongo is opened and when the job is done, this connection is closed (using Kiqstand middleware).</p>

<p>This is causing huge loads on our router server, and causing mongo to run out of file descriptors at times.</p>

<h2>SO?</h2>

<p>More then anything, this post is a callout for discussion with anyone using similar solution with similar scale and can assist, I know I would love to brainstorm on how to solve this problem.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/13/railsconf-2012-talk-how-gogobot-works/">RailsConf 2012 Talk - How Gogobot Works</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-13T18:37:00+02:00" pubdate data-updated="true">Nov 13<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/13/railsconf-2012-talk-how-gogobot-works/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My slides from the talk I gave at RailsConf Israel 2012.</p>

<script async class="speakerdeck-embed" data-id="0e2a2d400f220130018822000a1f82fb" src="//speakerdeck.com/assets/embed.js"></script>


<p>Enjoy!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/19/organizing-your-specs-into-groups-and-running-them-separately/">Organizing Your Specs Into Groups and Running Them Separately</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-19T13:57:00+03:00" pubdate data-updated="true">Aug 19<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/19/organizing-your-specs-into-groups-and-running-them-separately/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A while back I answered <a href="http://stackoverflow.com/questions/10029250/organizing-rspec-2-tests-into-unit-and-integration-categories-in-rails/10029504#10029504">this StackOverflow question</a>.</p>

<p>When you have a lot of specs, it makes sense to run them in separate logical groups and not just with <code>rspec spec</code> or something like that.</p>

<p>This way, you can save time and you can also run them in separate processes on the CI.</p>

<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle exec rake spec:unit
</span><span class='line'>bundle exec rake spec:integration
</span><span class='line'>bundle exec rake spec:api</span></code></pre></td></tr></table></div></figure>


<p>In order to achieve this, you need to change the <code>spec.rake</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">namespace</span> <span class="ss">:spec</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Rspec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:unit</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;spec/*/**/*_spec.rb&#39;</span><span class="o">].</span><span class="n">reject</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">[</span><span class="s1">&#39;/api/v1&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">f</span><span class="o">[</span><span class="s1">&#39;/integration&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="no">Rspec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:api</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;spec/*/{api/v1}*/**/*_spec.rb&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Rspec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:integration</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;spec/integration/**/*_spec.rb&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can continue customizing that all you want, you can run specific specs that are the most important to you.</p>

<p>I find those groups useful for most of my use cases, but with minor changes you can make it fit yours</p>

<h3>Using Rspec Tags</h3>

<p>You can use tags for that as well, but I find that more tedious and you can forget to <em>tag</em> something.</p>

<p>For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">it</span> <span class="s2">&quot;should do some integration test&quot;</span><span class="p">,</span> <span class="ss">:integration</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>   <span class="c1"># something</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/09/searching-through-the-history-of-commands-you-ran-in-terminal/">Searching Through the History of Commands You Ran in Terminal</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T00:06:00+03:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/09/searching-through-the-history-of-commands-you-ran-in-terminal/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Whenever I am logged in to a server or even when I am working on my own machine, I keep searching through the command history through up and down arrows.</p>

<p>While this can be efficient if you have 2-3 commands, it can be quite frustrating to find specific commands.</p>

<p>That is something I keep doing over and over again, and now I have a better way, I just grep through the list of commands, find the one I want, copy it and paste it into a new command, and I&#8217;m done.</p>

<p>This saves me <strong>a lot</strong> of time.</p>

<p>Here&#8217;s how:</p>

<p>To show the history of commands you just do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>history</span></code></pre></td></tr></table></div></figure>


<p>You probably know the rest, but you can just pipe the history into grep and search your history</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>history | grep {command_or_part_of_command}</span></code></pre></td></tr></table></div></figure>


<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>history | grep cp -R</span></code></pre></td></tr></table></div></figure>


<p>Enjoy!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Avi Tzurel</h1>
  <img src="https://si0.twimg.com/profile_images/1126793975/4991222376_977467af43_m.jpg" width="128" height="128" style="height: 128px; width: 128px; border-radius: 6px">
  <p>
  	Owner @ <a href="http://www.kensodev.com">KensoDev</a>, a boutique software consultancy based in Israel More <a href="/about">about me</a>.
  </p>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/22/export-mongo-collection-to-json-with-query/">Real life usage for mongoexport (and a bonus)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/06/how-to-easily-generate-beautiful-api-documentation/">How to easily generate beautiful api documentation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/14/move-jobs-from-one-queue-to-another-sidekiq/">Move jobs from one queue to another - Sidekiq</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/26/a-better-todo-comment-for-your-code/">Better TODO comment for your code</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/19/do-not-use-the-callbacks-that-require-persistence-in-mongoid/">DO NOT use the callbacks that require persistence in Mongoid</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("KensoDev", 5, true);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/KensoDev" class="twitter-follow-button" data-show-count="true">Follow @KensoDev</a>
  
</section>





<section>
  <h1>My Coderwall</h1>
  <ul id="cw_badges">
    <li class="loading">Status updating&#8230;</li>
  </ul>

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target)[0],
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.innerHTML = fragment;
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , type: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $.domReady(function(){
      if (!window.jXHR){
        var jxhr = document.createElement('script');
        jxhr.type = 'text/javascript';
        jxhr.src = '/javascripts/libs/jXHR.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(jxhr, s);
      }
      if (!window.$){
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.src = '/javascripts/ender.js';
        var sc = document.getElementsByTagName('script')[0];
        sc.parentNode.insertBefore(jxhr, s);
      }
      coderwall.showBadges({
        user: 'kensodev',
        target: '#cw_badges'
      });
    });
  </script>
  <style type="text/css">
    .cw_badge img {
      padding: 5px;
      border: 0 none !important;
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -o-box-shadow: none !important;
      box-shadow: none !important;
    }
  </style>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Avi Tzurel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'avi-io';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
